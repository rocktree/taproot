<%= simple_form_for [:builder, current_site, current_page] do |f| %>

  <%= f.simple_fields_for :field_data, OpenStruct.new(f.object.field_data) do |fd| %>
    <% current_template_group.fields.each do |field| %>
      <% if ['title','slug','position','description','show_in_nav'].include?(field.slug) %>
        <%= f.input field.slug.to_sym, :label => field.label %>
      <% elsif field.slug == 'body' %>
        <div class="body-buttons input">
          <label>Content / Body</label>
          <% if current_page.slug %>
            <%= link_to(
              'Launch Rich Text Editor', 
              builder_site_page_editor_path(current_site, current_page, 'wysiwyg'), 
              :class => 'button wysiwyg'
            ) %>
            <%= link_to(
              'Launch Markdown Editor', 
              builder_site_page_editor_path(current_site, current_page, 'markdown'), 
              :class => 'button markdown' 
            ) %>
          <% else %>
            <p>
              <em>Save the page to edit the content (we wouldn't want you to lose 
              your work!).</em>
            </p>
          <% end %>
          <%= f.input :body_md, :as => :hidden, :wrapper => false %>
          <%= f.input :body, :as => :hidden, :wrapper => false %>
        </div>
      <% else %>
        <% case field.data_type %>
        <% when 'date' %>
          <%= fd.input(
            :"#{field.slug}", 
            :as => :string, 
            :required => field.required, 
            :label => field.title,
            :input_html => { 
              :class => 'date-js', 
              :value => current_page.field_data[field.slug.to_sym] 
            } 
          ) %>
        <% when 'select' %>
          <%= fd.input(
            :"#{field.slug}", 
            :as => :"#{field.data_type}", 
            :collection => field.option_values,
            :required => field.required, 
            :label => field.title,
            :selected => current_page.field_data[field.slug],
          ) %>
        <% when 'check_boxes', 'radio_buttons' %>
          <%= fd.input(
            :"#{field.slug}", 
            :as => :"#{field.data_type}", 
            :collection => field.option_values,
            :required => field.required, 
            :label => field.title,
            :checked => current_page.field_data[field.slug]
          ) %>
        <% when 'image', 'file' %>
          <div class="upload-field">
            <%= fd.input(
              :"rtfile_#{field.slug}", 
              :as => :hidden, 
              :required => field.required, 
              :label => field.title,
              :input_html => { 
                :value => current_page.field_data[field.slug]
              } 
            ) %>
            <%= image_tag(
              find_page_thumb(current_page.field_data[field.slug])
            ) unless current_page.field_data[field.slug].blank? %>
            <%= link_to(
              "Add New #{field.title}", 
              builder_site_documents_path(current_site, :select => true), 
              :class => 'image-upload-trigger button' 
            ) %>
          </div>
        <% else %>
          <%= fd.input(
            :"#{field.slug}", 
            :as => :"#{field.data_type}", 
            :required => field.required, 
            :label => field.title,
            :input_html => { 
              :value => current_page.field_data[field.slug.to_sym] 
            } 
          ) %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>

  <%= redirect_field(f) %>

  <%= f.input :template_id, :as => :hidden, :wrapper => false, 
    :input_html => { :value => current_template.id } %>
  <%= f.input :parent_id, :as => :hidden, :wrapper => false, :input_html => { 
    :value => current_page_parent.id } unless current_page_parent.nil? %>

  <%= f.submit "Save Page" %>

<% end %>
